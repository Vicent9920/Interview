<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8" />
		<title>MarkDown文件加载</title>
		<style>
			body{
				background-color: blueviolet;
			}
			*{
				max-width: 100vw;
				text-overflow: ellipsis;
				overflow:hidden;
			};
		</style>
	</head>
	<script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
	<script type="text/javascript" src="js/marked.js"></script>
	<script type="text/javascript" src="js/http.js"></script>

	<body>

	</body>
	<script>
		
		loadData("https://github.com/JackyAndroid/AndroidInterview-Q-A/blob/master/README-CN.md");
		var isFirst = false;
		function loadData(url){
			function loadData(url){
			if(isFirst){
				alert(url);
			}else{
				isFirst = true;
			}
			var data1 = {
			"url": url
		};
		var data2 = {
			"isProcessing": {
				"val": false
			},
			"downloadedFiles": {
				"val": 0
			},
			"totalFiles": {
				"val": 0
			}
		};
		var data3 = {};
		downloadZippedFiles(data1, data2, data3);
		}
		
		function parseInfo(parameters) {
			
			var repoPath = new URL(parameters.url).pathname;
			console.log("repoPath："+repoPath);
			
			var splitPath = repoPath.split("/");
			console.log("splitPath："+splitPath);
			
			var info = {};
			
			info.author = splitPath[1];
			info.repository = splitPath[2];
			info.branch = splitPath[4];
			info.rootName = splitPath[splitPath.length - 1];
			
			if(!!splitPath[4]) {
				info.resPath = repoPath.substring(
					repoPath.indexOf(splitPath[4]) + splitPath[4].length + 1);
			}
			
			info.urlPrefix = "https://api.github.com/repos/" + info.author +
				"/" + info.repository + "/contents/";
			info.urlPostfix = "?ref=" + info.branch;
			if(!parameters.fileName || parameters.fileName == "") {
				info.downloadFileName = info.rootName;
			} else {
				info.downloadFileName = parameters.fileName;
			}
			if(parameters.rootDirectory == "false") {
				info.rootDirectoryName = "";
			} else if(!parameters.rootDirectory || parameters.rootDirectory == "" ||
				parameters.rootDirectory == "true") {
				info.rootDirectoryName = info.rootName + "/";
			} else {
				info.rootDirectoryName = parameters.rootDirectory + "/";
			}
			return info;
		}
		function downloadZippedFiles(parameters, progress, toastr) {
			var repoInfo = parseInfo(parameters);
			if(!repoInfo.resPath || repoInfo.resPath == "") {
				if(!repoInfo.branch || repoInfo.branch == "") {
					repoInfo.branch = "master";
				}
				var downloadUrl = "https://github.com/" + repoInfo.author + "/" +
					repoInfo.repository + "/archive/" + repoInfo.branch + ".zip";
				window.location = downloadUrl;
			} else {
				//普通get请求
				http.get(repoInfo.urlPrefix + repoInfo.resPath + repoInfo.urlPostfix, function(err, result) {
					if(err) {
						console.log(JSON.stringify(err));
					} else {
						$.get(result.download_url, function(response, status, xhr) {
							$("body").html(marked(response));
							alert($(document).height());
						});
					}
				});
				
			}
		}
	</script>

</html>